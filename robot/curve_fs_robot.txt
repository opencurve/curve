*** Settings ***
Library			  Collections
#Library           RequestsLibrary
Library           Process
#Library           SSHLibrary
Library           Resources/keywords/fs_fault_inject.py
Library           Resources/keywords/deploy.py

Suite Setup       init failover cluster
Suite Teardown    clean failover env

*** Variables ***
${fio_vdsize}     10
${vdbench_vdsize}   10
${vm_iops_limit}   8000
${chunk_num}   0

*** Test Cases ***
inject kill one mds
    [Tags]    P1    base    first release   failover
    ${num}   evaluate  int(1)
    test kill process   mds   ${num}
    check fuse iops
    sleep  3
    test start process  mds
    check fuse mount success
    check fuse iops
    check fs cluster ok
    [Teardown]    test start process  mds

inject kill two mds
    [Tags]    P1    base    first release   failover
    ${num}   evaluate  int(2)
    test kill process   mds   ${num}
    sleep  5
    test start process  mds
    sleep  5
    check fuse mount success
    check fuse iops
    check fs cluster ok
    [Teardown]    test start process  mds

inject kill all mds
    [Tags]    P1    base    first release   failover
    ${num}   evaluate  int(3)
    test kill process   mds   ${num}
    sleep  5
    test start process  mds
    sleep  5
    check fuse mount success
    check fuse iops
    check fs cluster ok
    [Teardown]    test start process  mds

inject kill one metaserver
    [Tags]    P1    base    first release   failover
    ${num}   evaluate  int(1)
    test kill process   metaserver   ${num}
    check fuse iops
    sleep  3
    test start process  metaserver
    check fuse mount success
    check fuse iops
    check fs cluster ok
    [Teardown]    test start process  metaserver

inject kill two metaserver
    [Tags]    P1    base    first release   failover
    ${num}   evaluate  int(2)
    test kill process   metaserver   ${num}
    sleep  5
    test start process  metaserver
    sleep  5
    check fuse mount success
    check fuse iops
    check fs cluster ok
    [Teardown]    test start process  metaserver

inject kill all metaserver
    [Tags]    P1    base    first release   failover
    ${num}   evaluate  int(3)
    test kill process   metaserver   ${num}
    sleep  5
    test start process  metaserver
    sleep  5
    check fuse mount success
    check fuse iops
    check fs cluster ok
    [Teardown]    test start process  metaserver

inject kill one etcd
    [Tags]    P1    base    first release   failover
    ${num}   evaluate  int(1)
    test kill process   etcd   ${num}
    check fuse iops
    sleep  3
    test start process  etcd
    check fuse mount success
    check fuse iops
    check fs cluster ok
    [Teardown]    test start process  etcd

inject kill two etcd
    [Tags]    P1    base    first release   failover
    ${num}   evaluate  int(2)
    test kill process   etcd   ${num}
    sleep  5
    test start process  etcd
    sleep  5
    check fuse mount success
    check fuse iops
    check fs cluster ok
    [Teardown]    test start process  etcd

inject kill all etcd
    [Tags]    P1    base    first release   failover
    ${num}   evaluate  int(3)
    test kill process   etcd   ${num}
    sleep  5
    test start process  etcd
    sleep  5
    check fuse mount success
    check fuse iops
    check fs cluster ok
    [Teardown]    test start process  etcd

check cp/mv data consistency
    [Tags]    P1    base    first release   failover
    checksum data
    check fuse mount success

check umount date consistency
    [Tags]    P1    base    first release   failover
    wait op finish
    sleep  60
    get test dir file md5
#    umount test dir
#    wait fuse exit
#    mount test dir
#    check test dir file md5
#    [Teardown]   mount test dir

test_multi_mdtest
    [Tags]    P1    base    first release   failover
    ${numjobs}   evaluate  int(16)
    ${filenum}   evaluate  int(1000)
    ${filesize}   evaluate  int(1024)
    multi_mdtest_exec   ${numjobs}   ${filenum}   ${filesize}
    check fuse mount success
    check fs cluster ok

*** Keywords ***

init failover cluster
     clean env
     change cfg
     destroy curvefs
     clean log
     deploy all servers
     check fs cluster ok
     mount test dir
     check fuse mount success
     write check data
     cp check data
     start fs op test

clean log
     clean fs kernel log
     clean corefile

start fs op test
     start fs vdbench
     start fs fio
     sleep  60

clean failover env
     check log
#     destroy curvefs

check log
     check fs io error
     check vdbench output
     check corefile

