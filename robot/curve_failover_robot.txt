*** Settings ***
Library           Resources/keywords/base_operate.py
Library           Resources/test/curve_base_test.py
Library           Resources/swig/swig_operate.py
Library			  Collections
Library           RequestsLibrary
Library           Process
Library           SSHLibrary
Library           Resources/keywords/mythread.py
Library           Resources/keywords/fault_inject.py
Library           Resources/keywords/deploy.py

Suite Setup       init failover cluster
Suite Teardown    clean failover env

*** Variables ***
${fio_vdsize}     20
${vdbench_vdsize}   20
${vm_iops_limit}   8000


*** Test Cases ***
#test up all cs
#    [Tags]    P8    base    first release
#    up all cs
#    [Teardown]   file clean    none


test get all chunk num
    [Tags]    P1    base    first release   failover   
    stop rwio
    sleep  2
    ${begin_num}    get all chunk num
    ${begin_num}    Convert To Integer  ${begin_num}
    exec deleteforce
    ${end_num}    get all chunk num
    ${end_num}    Convert To Integer   ${end_num}
    should be equal    ${begin_num}   ${end_num}


inject one chunkserver down/up
    [Tags]    P1    base    first release   failover
    init rw cloud disk
    ${num}   evaluate   int(1)
    ${host}   test kill chunkserver num   ${num}
    sleep  5
    check vm iops
    check data consistency
#    check copies consistency
    sleep  5
    test start chunkserver num   ${num}  ${host}
    sleep  5
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]	  start host cs process   ${host}

inject two chunkserver down/up
    [Tags]    P1    base    first release   failover
    ${num}   evaluate   int(2)
    ${host}   test kill chunkserver num   ${num}
    sleep  5
    check vm iops
    check data consistency
#    check copies consistency
    sleep  5
    test start chunkserver num   ${num}  ${host}
    sleep  5
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]	  start host cs process   ${host}

inject host all chunkserver down/up
    [Tags]    P1    base    first release   failover
    ${host}  test stop chunkserver host
    sleep  10
    check vm iops
    check data consistency
#    check copies consistency
    sleep  5
    test start chunkserver host  ${host}
    sleep  5
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]	  start host cs process  ${host}

inject restart one chunkserver
    [Tags]    P1    base    first release   failover
    ${num}   evaluate   int(1)
    test restart chunkserver num   ${num}
    sleep  5
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]	  wait iops ok   ${vm_iops_limit}

inject restart two chunkserver
    [Tags]    P1    base    first release   failover
    ${num}   evaluate   int(2)
    test restart chunkserver num   ${num}
    sleep  5
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]	 wait iops ok    ${vm_iops_limit}

inject kill diff host chunkserver
    [Tags]    P1    base    first release   failover
    test kill diff host chunkserver
    sleep   5
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]	 wait iops ok    ${vm_iops_limit}

inject stop and start vm
    [Tags]    P1    base    first release   failover
    test start vm
    sleep   10
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]	 wait iops ok     ${vm_iops_limit}

inject reboot vm
    [Tags]    P1    base    first release   failover
    test restart vm
    sleep   5
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]	  wait iops ok    ${vm_iops_limit}

inject kill mds
    [Tags]    P1    base    first release   failover   no-need
    ${host}  test kill mds
    ${limit_iops}   evaluate  int(0)
    sleep  5
    check vm iops  ${limit_iops}
    sleep  3
    test start mds
    sleep  3
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]	   start mds process  ${host}

inject kill etcd
    [Tags]    P1    base    first release   failover   no-need
    ${host}  test kill etcd
    ${limit_iops}   evaluate  int(0)
    sleep  5
    check vm iops  ${limit_iops}
    sleep  3
    test start etcd   ${host}
    sleep  3
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]     start etcd process  ${host}

inject kill mysql
    [Tags]    P1    base    first release   failover   no-need
    ${host}  test kill mysql
    ${limit_iops}   evaluate  int(0)
    sleep  5
    check vm iops   ${limit_iops} 
    sleep  3
    test start mysql
    sleep  3
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]     start mysql process  ${host}

inject chunkserver cpu stress 95%
    [Tags]    P1    base    first release   failover 
    ${cpu_stress}   evaluate  int(95)
    ${ssh}   test chunkserver cpu stress   ${cpu_stress}
    sleep  5
    ${limit_iops}   evaluate  int(2000)
    check vm iops    ${limit_iops} 
    del cpu stress   ${ssh}
    check vm iops    ${vm_iops_limit} 
    check data consistency
#    check copies consistency
    [Teardown]     del cpu stress    ${ssh}
    
inject mds cpu stress 95%
    [Tags]    P1    base    first release   failover
    ${cpu_stress}   evaluate  int(95)
    ${ssh}   test mds cpu stress   ${cpu_stress}
    sleep  5
    ${limit_iops}   evaluate  int(2000)
    check vm iops    ${limit_iops} 
    del cpu stress   ${ssh}
    check vm iops    ${vm_iops_limit} 
    check data consistency
#    check copies consistency
    [Teardown]     del cpu stress    ${ssh}

inject client cpu stress 95%
    [Tags]    P1    base    first release   failover
    ${cpu_stress}   evaluate  int(95)
    ${ssh}   test client cpu stress   ${cpu_stress}
    sleep  5
    ${limit_iops}   evaluate  int(2000)
    check vm iops    ${limit_iops} 
    del cpu stress   ${ssh}
    check vm iops    ${vm_iops_limit} 
    check data consistency
#    check copies consistency
    [Teardown]     del cpu stress    ${ssh}

inject chunkserver mem stress 95%
    [Tags]    P1    base    first release   failover
    ${cpu_stress}   evaluate  int(95)
    ${ssh}   test chunkserver mem stress   ${cpu_stress}
    sleep  10
    check vm iops    ${vm_iops_limit}
    del mem stress   ${ssh}
    check data consistency
#    check copies consistency
    [Teardown]     del mem stress    ${ssh}

inject mds mem stress 95%
    [Tags]    P1    base    first release   failover
    ${cpu_stress}   evaluate  int(95)
    ${ssh}   test mds mem stress   ${cpu_stress}
    sleep  10
    check vm iops    ${vm_iops_limit}
    del mem stress   ${ssh}
    check data consistency
#    check copies consistency
    [Teardown]     del mem stress    ${ssh}

inject client mem stress 95%
    [Tags]    P1    base    first release   failover
    ${cpu_stress}   evaluate  int(95)
    ${ssh}   test client mem stress   ${cpu_stress}
    sleep  10
    check vm iops    ${vm_iops_limit}
    del mem stress   ${ssh}
    check data consistency
#    check copies consistency
    [Teardown]     del mem stress    ${ssh}

test chunkserver loss package 5%
    [Tags]    P1    base    first release   failover
    ${percent}  evaluate  int(5)
    test cs loss package  ${percent}
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]	   wait iops ok    ${vm_iops_limit}

test mds loss package 5%
    [Tags]    P1    base    first release   failover
    ${percent}  evaluate  int(5)
    test mds loss package  ${percent}
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]	   wait iops ok   ${vm_iops_limit}

test chunkserver delay package 100ms
    [Tags]    P1    base    first release   failover
    ${ms}  evaluate  int(100)
    test cs delay package  ${ms}
    sleep  5
    check vm iops
    check data consistency
#    check copies consistency
    sleep   5
    [Teardown]	 wait iops ok    ${vm_iops_limit}

test mds delay package 100ms
    [Tags]    P1    base    first release   failover
    ${ms}  evaluate  int(100)
    test mds delay package  ${ms}
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]	   wait iops ok   ${vm_iops_limit}

test out/in chunkserver recover
    [Tags]    P1    base    first release   failover  longtime
    ${host}	${cs_copyset_num}  test outcs recover copyset
    check vm iops
    check data consistency
#    check copies consistency
    ${copyset_num}       Convert To Integer    ${cs_copyset_num}
    test upcs recover copyset  ${host}	 ${copyset_num}
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]	   wait iops ok    ${vm_iops_limit}

test suspend up recover chunkserver
    [Tags]    P1    base    first release   failover  longtime
    test suspend recover copyset
#    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]	   wait iops ok   ${vm_iops_limit}

test stop all cs not recover
    [Tags]    P1    base    first release   failover
    stop all cs not recover
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]	  wait iops ok   ${vm_iops_limit}

test pendding host all cs
   [Tags]    P1    base    first release   failover  longtime
   pendding all cs recover 
   check vm iops 
   check data consistency
#   check copies consistency
    [Teardown]	  wait iops ok   ${vm_iops_limit}

stop attach detach thread
    [Tags]    P1    base    first release   failover
    stop attach detach
    [Teardown]   wait iops ok    ${vm_iops_limit}

inject all chunkserver down
    [Tags]    P1    base    first release   failover
    test stop all chunkserver
    test start all chunkserver
    sleep   5
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]   wait iops ok    ${vm_iops_limit}

inject all chunkserver down 10min
    [Tags]    P1    base    first release   failover
    test stop all chunkserver
    sleep   600
    test start all chunkserver
    sleep   5
    check vm iops
    check data consistency
#    check copies consistency
    [Teardown]   wait iops ok    ${vm_iops_limit}

*** Keywords ***

init failover cluster
     init abnormal test env
     init vm
     loop attach detach vol

init abnormal test env
     destroy etcd
     destroy mds
     drop all chunkserver dat
     drop abnormal test db
     install deb
     add config 
     start abnormal test services
     create pool
     restart cinder server
     wait cinder server up 

init rw cloud disk
     remove vm key
     attach new vol   ${fio_vdsize}   ${vdbench_vdsize} 
     stop rwio
     sleep  5
     write full disk   ${fio_vdsize}
     run rwio

clean failover env
     stop rwio
     check copies consistency
#     stop attach detach 
     detach vol
